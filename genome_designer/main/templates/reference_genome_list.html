{% extends "tab_base.html" %}

{% block content%}
<div class="page-header">
  <h1>Reference Genomes</h1>
</div>

<p>
  {% if error_string %}
    <div class="alert alert-error alert-block">
      <button type="button" class="close" data-dismiss="alert">&times;</button>
      <h4>Error</h4>
      {{ error_string }}
    </div>
  {% endif %}

  <div class="btn-group">
    <a class="btn dropdown-toggle btn-primary" data-toggle="dropdown" href="#">
      Create New
      <span class="caret"></span>
    </a>
    <ul class="dropdown-menu">
      <li role="presentation"><a role="menuitem" tabindex="-1" href="#">From Variant Set...</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="#modalFromFile" data-toggle="modal">From Server Location...</a></li>
       <li role="presentation"><a role="menuitem" tabindex="-1" href="#modalUpload" data-toggle="modal">Upload to S3...</a></li>
    </ul>
  </div>
</p>

<div id="gd-ref-genome-list-view-datatable-hook" class="container-fluid">
</div>

<!-- Modal -->
<div id="modalFromFile" class="modal hide fade" tabindex="-1" role="dialog">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">×</button>
    <h3 id="modalFromFile">Load File from Server Location</h3>
  </div>
  <div class="modal-body">
    <form id="formFromFile" method="POST">
      {% csrf_token %}
      <input type="text" name="refGenomeLabel" placeholder="Reference Genome Name">
      <input type="text" name="refGenomeFileLocation" placeholder="File Location on Server">
      <label class="radio">
        <input type="radio" name="importFileFormat" id="optionsRadios1" value="genbank" checked>
        Genbank File
      </label>
      <label class="radio">
        <input type="radio" name="importFileFormat" id="optionsRadios2" value="fasta">
        FASTA File <i>(No Gene/Effect Annotations)</i>
      </label>
    </div>
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal">Cancel</button>
      <button class="btn btn-primary" id="formFromFile">Submit</button>
    </form>
  </div>
</div>

<div id="modalUpload" class="modal hide fade" tabindex="-1" role="dialog">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">×</button>
    <h3>Upload</h3>
  </div>
  <div class="modal-body" id="uploadDiv">
  </div>
</div>

<script type="text/javascript">
  VIEW_TAG = 'REF_GENOME_LIST';

  {% autoescape off %}
    REF_GENOME_LIST_DATA = {{ref_genome_list_json}};
  {% endautoescape %}

  $(function() {
    var uploader = $("#uploadDiv").fineUploaderS3({
      debug: true,
      request: {
        endpoint: '{{ S3_BUCKET }}.s3.amazonaws.com',
        accessKey: '{{ AWS_SERVER_PUBLIC_KEY }}'
      },
      signature: {
        endpoint: '{% url "s3_signature" %}'
      },
      uploadSuccess: {
        endpoint: '{% url "s3_success" %}'
      },
      retry: {
        enableAuto: true
      },
      chunking: {
        enabled: true
      },
      deleteFile: {
        endpoint: '{% url "s3_delete" %}',
        enabled: true,
        forceConfirm: true
      },
      callbacks: {
        onError: function(id, name, reason) {
          alert(reason);
        }
      }
    }).on('complete', function(id, name, response, xhr) {
      var sid = xhr.s3file_id;
      $.post('{% url "import_reference_genome_s3" project.uid %}', 
              {'s3file_id': sid},
              function(data) {
                alert("Uploaded. Awaiting processing...");
              });
      });
  });

</script>

<script type="text/template" id="qq-template">
<div class="qq-uploader-selector qq-uploader">
  <div class="qq-upload-drop-area-selector qq-upload-drop-area" qq-hide-dropzone>
    <span>Drop files here to upload</span>
  </div>
  <div class="qq-upload-button-selector qq-upload-button btn btn-success" style="width: auto;">
    <div><i class="icon-upload icon-white"></i> Choose files...</div>
  </div>
  <span class="qq-drop-processing-selector qq-drop-processing">
    <span>Processing dropped files...</span>
    <span class="qq-drop-processing-spinner-selector qq-drop-processing-spinner"></span>
  </span>
  <ul class="qq-upload-list-selector qq-upload-list" style="margin-top: 10px; text-align: center;">
    <li>
      <div class="qq-progress-bar-container-selector progress-striped">
          <div class="qq-progress-bar-selector qq-progress-bar bar"></div>
      </div>
      <span class="qq-upload-spinner-selector qq-upload-spinner"></span>
      <span class="qq-upload-file-selector qq-upload-file"></span>
      <span class="qq-upload-size-selector qq-upload-size"></span>
      <a class="qq-upload-cancel-selector qq-upload-cancel" href="#">Cancel</a>
      <span class="qq-upload-status-text-selector qq-upload-status-text"></span>
    </li>
  </ul>
</div>
</script>
{% endblock %}
